{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<h3>Reporte de ventas</h3>

<div class="mb-3">
  <div class="btn-group" role="group" aria-label="Periodo rápido">
    <a href="?periodo=semana" class="btn btn-sm {% if periodo == 'semana' %}btn-primary{% else %}btn-outline-primary{% endif %}">Semana actual</a>
    <a href="?periodo=mes" class="btn btn-sm {% if periodo == 'mes' %}btn-primary{% else %}btn-outline-primary{% endif %}">Mes actual</a>
    <a href="?periodo=anio" class="btn btn-sm {% if periodo == 'anio' %}btn-primary{% else %}btn-outline-primary{% endif %}">Año actual</a>
  </div>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-md-3">
    <label class="form-label">Inicio</label>
    <input type="date" name="inicio" class="form-control" value="{{ inicio|date:'Y-m-d' }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Fin</label>
    <input type="date" name="fin" class="form-control" value="{{ fin|date:'Y-m-d' }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Producto</label>
    <select name="producto" class="form-select">
      <option value="">— Todos —</option>
      {% for p in productos %}
        <option value="{{ p.id }}" {% if producto_id == p.id %}selected{% endif %}>{{ p.nombre }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Empleado</label>
    <select name="empleado" class="form-select">
      <option value="">— Todos —</option>
      {% for e in empleados %}
        <option value="{{ e.id }}" {% if empleado_id == e.id %}selected{% endif %}>{{ e.usuario.username }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Cliente</label>
    <select name="cliente" class="form-select">
      <option value="">— Todos —</option>
      {% for c in clientes %}
        <option value="{{ c.id }}" {% if cliente_id == c.id %}selected{% endif %}>{{ c.nombre }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3 d-flex align-items-end gap-2">
    <button class="btn btn-primary" type="submit">Filtrar</button>
    <a class="btn btn-outline-secondary" href="{% url 'reportes:ventas' %}">Limpiar</a>
    <a class="btn btn-outline-success" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}export=xlsx">XLSX</a>
    <a class="btn btn-outline-danger" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}export=pdf" target="_blank">PDF</a>
  </div>
</form>
<table class="table table-striped">
  <thead>
    <tr><th>#</th><th>Fecha</th><th>Cliente</th><th>Estado</th><th class="text-end">Subtotal</th><th class="text-end">IVA</th><th class="text-end">Total</th></tr>
  </thead>
  <tbody>
  {% for p in pedidos %}
    <tr>
      <td>{{ p.id }}</td>
      <td>{{ p.fecha_pedido|date:'d-m-Y H:i' }}</td>
      <td>{{ p.cliente.nombre }}</td>
      <td><span class="badge bg-info">{{ p.estado }}</span></td>
      <td class="text-end">$ {{ p.subtotal|intcomma }}</td>
      <td class="text-end">$ {{ p.iva|intcomma }}</td>
      <td class="text-end">$ {{ p.total|intcomma }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="7">Sin resultados.</td></tr>
  {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="4" class="text-end">Totales</th>
      <th class="text-end">$ {{ total_subtotal|intcomma }}</th>
      <th class="text-end">$ {{ total_iva|intcomma }}</th>
      <th class="text-end">$ {{ total_total|intcomma }}</th>
    </tr>
  </tfoot>
</table>

<h4 class="mt-4">Resumen por vendedor</h4>
<table class="table table-sm table-hover">
  <thead>
    <tr>
      <th>Vendedor</th>
      <th class="text-end">Pedidos</th>
      <th class="text-end">Total vendido</th>
    </tr>
  </thead>
  <tbody>
    {% for r in resumen_vendedores %}
    <tr>
      <td>{{ r.empleado__usuario__username|default:"(Sin asignar)" }}</td>
      <td class="text-end">{{ r.num_pedidos }}</td>
      <td class="text-end">$ {{ r.total_ventas|intcomma }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="3" class="text-muted">Sin datos para el periodo seleccionado.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
